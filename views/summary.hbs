<div class="page-header">
  <h1><i class="fas fa-chart-bar me-2"></i>Connection Statistics by IP</h1>
  <p class="viewer-ip"><i class="fas fa-eye me-2"></i>You are viewing this page from IP <span class="ip-address">{{ip}}</span></p>
</div>

<div class="filter-box">
  <div class="input-group">
    <span class="input-group-text bg-light border-end-0">
      <i class="fas fa-search text-muted"></i>
    </span>
    <input 
      type="text" 
      id="searchInput" 
      placeholder="Search by IP or username" 
      class="form-control filter-input border-start-0"
    />
  </div>
</div>

<div class="table-responsive">
  <table id="ipSummaryTable" class="log-table sortable-table">
    <thead>
      <tr>
        <th data-key="ip"><i class="fas fa-globe me-2"></i>IP Address</th>
        <th data-key="success"><i class="fas fa-check-circle me-2"></i>Successful</th>
        <th data-key="failure"><i class="fas fa-times-circle me-2"></i>Failed</th>
        <th data-key="usernames"><i class="fas fa-user me-2"></i>Usernames</th>
      </tr>
    </thead>
    <tbody>
      {{#each rows}}
        <tr class="{{#if (gt success 10)}}high-success{{/if}} {{#if (gt failure 5)}}high-failure{{/if}}">
          <td><i class="fas fa-network-wired me-2 text-primary"></i>{{ip}}</td>
          <td><span class="badge bg-success">{{success}}</span></td>
          <td><span class="badge bg-danger">{{failure}}</span></td>
          <td><span class="usernames">{{usernames}}</span></td>
        </tr>
      {{/each}}
    </tbody>
  </table>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const input = document.getElementById('searchInput');
  const table = document.getElementById('ipSummaryTable');
  const headers = table.querySelectorAll('th[data-key]');
  const rows = Array.from(table.querySelectorAll('tbody tr'));
  let currentSort = { key: null, direction: 'asc' };

  // Add animation to rows
  rows.forEach((row, index) => {
    row.style.animationDelay = `${index * 0.05}s`;
  });

  // Filter table
  input.addEventListener('input', () => {
    const value = input.value.toLowerCase();
    let hasVisibleRows = false;
    
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      const isVisible = text.includes(value);
      row.style.display = isVisible ? '' : 'none';
      
      if (isVisible) hasVisibleRows = true;
    });
    
    // Show message when no results found
    let noResultsRow = table.querySelector('.no-results');
    if (!hasVisibleRows && !noResultsRow) {
      noResultsRow = document.createElement('tr');
      noResultsRow.className = 'no-results';
      noResultsRow.innerHTML = `<td colspan="4">No results found</td>`;
      table.querySelector('tbody').appendChild(noResultsRow);
    } else if (hasVisibleRows && noResultsRow) {
      noResultsRow.remove();
    }
  });

  // Sort table
  headers.forEach(th => {
    th.addEventListener('click', () => {
      const key = th.dataset.key;
      const index = Array.from(th.parentNode.children).indexOf(th);
      const direction = currentSort.key === key && currentSort.direction === 'asc' ? 'desc' : 'asc';
      currentSort = { key, direction };

      // Remove sort classes from all headers
      headers.forEach(h => {
        h.classList.remove('sorted-asc', 'sorted-desc');
        h.querySelector('i').className = 'fas me-2';
      });
      
      // Add sort class to current header
      th.classList.add(direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
      
      // Change header icon
      const icon = th.querySelector('i');
      icon.className = direction === 'asc' ? 'fas fa-sort-up me-2' : 'fas fa-sort-down me-2';

      // Sort rows
      const sorted = rows.sort((a, b) => {
        let aText = a.children[index].textContent.trim();
        let bText = b.children[index].textContent.trim();
        
        // Remove icons and badges from text
        aText = aText.replace(/<[^>]*>/g, '').trim();
        bText = bText.replace(/<[^>]*>/g, '').trim();
        
        const aVal = isNaN(aText) ? aText.toLowerCase() : Number(aText);
        const bVal = isNaN(bText) ? bText.toLowerCase() : Number(bText);
        
        return direction === 'asc'
          ? aVal > bVal ? 1 : aVal < bVal ? -1 : 0
          : aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
      });

      // Add sorted rows to table
      const tbody = table.querySelector('tbody');
      tbody.innerHTML = '';
      sorted.forEach(row => tbody.appendChild(row));
    });
  });
});
</script>